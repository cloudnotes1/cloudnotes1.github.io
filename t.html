<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Notes - Material 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fdfbff; /* M3 Surface */
            color: #1c1b1f; /* M3 On Surface */
            margin: 0;
        }
        
        /* Material 3 Color Tokens & Styles */
        .m3-surface-container { background-color: #f3edf7; }
        .m3-primary { background-color: #6750a4; color: #ffffff; }
        .m3-primary:hover { background-color: #55408a; }
        .m3-primary-container { background-color: #eaddff; color: #21005d; }
        .m3-primary-container:hover { background-color: #d8c8f8; }
        .m3-secondary-container { background-color: #e8def8; color: #1d192b; }
        .m3-error { color: #b3261e; }
        
        /* M3 Inputs */
        .m3-input-wrapper {
            position: relative;
            background-color: #e7e0ec; /* Surface variant */
            border-radius: 4px 4px 0 0;
            padding: 8px 16px;
            border-bottom: 1px solid #49454f; /* On surface variant */
            transition: all 0.2s ease;
        }
        .m3-input-wrapper:focus-within {
            border-bottom: 2px solid #6750a4; /* Primary */
        }
        .m3-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-size: 16px;
            color: #1c1b1f;
            padding-top: 12px;
            padding-bottom: 4px;
        }
        .m3-label {
            position: absolute;
            top: 8px;
            left: 16px;
            font-size: 12px;
            color: #49454f;
            transition: all 0.2s ease;
            pointer-events: none;
        }
        .m3-input:placeholder-shown + .m3-label {
            top: 16px;
            font-size: 16px;
        }
        .m3-input:focus + .m3-label,
        .m3-input:not(:placeholder-shown) + .m3-label {
            top: 8px;
            font-size: 12px;
            color: #6750a4;
        }

        /* FAB */
        .m3-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-center;
            box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s, background-color 0.2s;
            cursor: pointer;
        }
        .m3-fab:hover {
            box-shadow: 0 6px 12px 4px rgba(0,0,0,0.15);
        }

        /* Note Card */
        .note-card {
            border: 1px solid #cac4d0;
            border-radius: 12px;
            transition: background-color 0.2s;
        }
        .note-card:hover {
            background-color: #f3edf7;
        }

        /* Snackbar */
        .snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #313033;
            color: #f4eff4;
            padding: 14px 16px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .snackbar.show {
            opacity: 1;
        }

        /* Dialog */
        .dialog-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
        }
        .dialog-content {
            background: #fdfbff;
            border-radius: 28px;
            box-shadow: 0 24px 38px 3px rgba(0,0,0,0.14);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cac4d0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #49454f; }
    </style>
</head>
<body class="antialiased">

    <!-- Snackbar for notifications -->
    <div id="snackbar" class="snackbar shadow-lg"></div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="m3-surface-container rounded-[28px] p-8 w-full max-w-md shadow-sm">
            <div class="text-center mb-8">
                <span class="material-symbols-outlined text-5xl text-[#6750a4] mb-2">description</span>
                <h1 class="text-3xl font-normal" id="auth-title">Welcome Back</h1>
                <p class="text-[#49454f] mt-2">Sign in to sync your notes</p>
            </div>

            <!-- Email/Password Form -->
            <form id="auth-form" class="space-y-4">
                <div class="m3-input-wrapper">
                    <input type="email" id="email" class="m3-input" placeholder=" " required>
                    <label class="m3-label">Email address</label>
                </div>
                <div class="m3-input-wrapper">
                    <input type="password" id="password" class="m3-input" placeholder=" " required>
                    <label class="m3-label">Password</label>
                </div>
                
                <div id="auth-error" class="text-sm m3-error hidden"></div>

                <button type="submit" id="auth-submit-btn" class="w-full m3-primary rounded-full py-2.5 font-medium mt-4">
                    Sign In
                </button>
            </form>

            <div class="mt-4 flex items-center justify-between text-sm">
                <button id="toggle-auth-mode" class="text-[#6750a4] font-medium hover:underline focus:outline-none">
                    Create an account instead
                </button>
            </div>

            <div class="relative flex py-6 items-center">
                <div class="flex-grow border-t border-[#cac4d0]"></div>
                <span class="flex-shrink-0 mx-4 text-[#49454f] text-sm">or</span>
                <div class="flex-grow border-t border-[#cac4d0]"></div>
            </div>

            <!-- Google Sign In -->
            <button id="google-signin-btn" class="w-full border border-[#79747e] rounded-full py-2.5 flex items-center justify-center gap-2 hover:bg-[#e8def8] transition-colors text-[#49454f] font-medium">
                <svg viewBox="0 0 24 24" class="w-5 h-5">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen" class="hidden min-h-screen flex flex-col">
        <!-- App Bar -->
        <header class="m3-surface-container px-4 py-3 flex items-center justify-between sticky top-0 z-10 shadow-sm">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[#6750a4] text-3xl">edit_note</span>
                <h1 class="text-xl font-medium">Cloud Notes</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="user-email-display" class="hidden sm:inline text-sm text-[#49454f]"></span>
                <button id="signout-btn" class="w-10 h-10 rounded-full hover:bg-[#eaddff] flex items-center justify-center transition-colors text-[#49454f]" title="Sign Out">
                    <span class="material-symbols-outlined">logout</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="flex justify-center py-12 hidden">
                <span class="material-symbols-outlined animate-spin text-4xl text-[#6750a4]">progress_activity</span>
            </div>

            <!-- Notes Grid -->
            <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Notes will be injected here via JS -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
                <span class="material-symbols-outlined text-6xl text-[#cac4d0] mb-4">note_stack</span>
                <h2 class="text-xl text-[#1c1b1f] font-medium">No notes yet</h2>
                <p class="text-[#49454f] mt-1">Tap the + button to create your first note.</p>
            </div>
        </main>

        <!-- Floating Action Button -->
        <button id="add-note-fab" class="m3-fab m3-primary-container z-20 flex justify-center" title="Add Note">
            <span class="material-symbols-outlined text-[28px]">add</span>
        </button>
    </div>

    <!-- NOTE MODAL/DIALOG -->
    <div id="note-dialog" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 dialog-overlay opacity-0 transition-opacity duration-200">
        <div class="dialog-content w-full max-w-lg flex flex-col transform scale-95 transition-transform duration-200" id="note-dialog-card">
            <div class="p-6 flex-grow flex flex-col gap-4">
                <input type="hidden" id="edit-note-id">
                
                <input type="text" id="note-title" placeholder="Title" class="w-full text-2xl font-medium bg-transparent border-none outline-none text-[#1c1b1f] placeholder-[#49454f]">
                
                <textarea id="note-content" placeholder="Note content" class="w-full min-h-[200px] resize-none bg-transparent border-none outline-none text-[#1c1b1f] placeholder-[#49454f] mt-2 text-base"></textarea>
            </div>
            
            <div class="p-4 flex items-center justify-end gap-2 border-t border-[#e7e0ec]">
                <button id="close-dialog-btn" class="px-6 py-2.5 rounded-full text-[#6750a4] font-medium hover:bg-[#eaddff] transition-colors">
                    Cancel
                </button>
                <button id="save-note-btn" class="px-6 py-2.5 rounded-full m3-primary font-medium transition-colors shadow-sm">
                    Save Note
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            deleteDoc, 
            doc, 
            updateDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfCHOpzMc4ER7cRnZlnGzf5t3kh9EVQ44",
            authDomain: "cloudnotes-bd76c.firebaseapp.com",
            projectId: "cloudnotes-bd76c",
            storageBucket: "cloudnotes-bd76c.firebasestorage.app",
            messagingSenderId: "625498466879",
            appId: "1:625498466879:web:af13aeeac06d532de9e68a",
            measurementId: "G-DDVF4NPEXV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Variables ---
        let currentUser = null;
        let isSignUpMode = false;
        let unsubscribeNotes = null;
        let allNotes = [];

        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const authError = document.getElementById('auth-error');
        const userEmailDisplay = document.getElementById('user-email-display');
        const signoutBtn = document.getElementById('signout-btn');
        const notesGrid = document.getElementById('notes-grid');
        const emptyState = document.getElementById('empty-state');
        const loadingIndicator = document.getElementById('loading-indicator');
        const addNoteFab = document.getElementById('add-note-fab');
        const noteDialog = document.getElementById('note-dialog');
        const noteDialogCard = document.getElementById('note-dialog-card');
        const closeDialogBtn = document.getElementById('close-dialog-btn');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const noteTitleInput = document.getElementById('note-title');
        const noteContentInput = document.getElementById('note-content');
        const editNoteIdInput = document.getElementById('edit-note-id');
        const snackbar = document.getElementById('snackbar');

        // --- UI Utilities ---
        function showSnackbar(message) {
            snackbar.textContent = message;
            snackbar.classList.add('show');
            setTimeout(() => {
                snackbar.classList.remove('show');
            }, 3000);
        }

        function toggleDialog(show, isEdit = false) {
            if (show) {
                noteDialog.classList.remove('hidden');
                // Trigger reflow for animation
                void noteDialog.offsetWidth; 
                noteDialog.classList.remove('opacity-0');
                noteDialogCard.classList.remove('scale-95');
                if(!isEdit) {
                    noteTitleInput.value = '';
                    noteContentInput.value = '';
                    editNoteIdInput.value = '';
                }
                noteTitleInput.focus();
            } else {
                noteDialog.classList.add('opacity-0');
                noteDialogCard.classList.add('scale-95');
                setTimeout(() => {
                    noteDialog.classList.add('hidden');
                }, 200);
            }
        }

        // --- Authentication Flow ---
        toggleAuthModeBtn.addEventListener('click', () => {
            isSignUpMode = !isSignUpMode;
            authTitle.textContent = isSignUpMode ? 'Create Account' : 'Welcome Back';
            authSubmitBtn.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            toggleAuthModeBtn.textContent = isSignUpMode ? 'Sign in instead' : 'Create an account instead';
            authError.classList.add('hidden');
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            authError.classList.add('hidden');
            authSubmitBtn.disabled = true;
            authSubmitBtn.style.opacity = '0.7';

            try {
                if (isSignUpMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                authError.textContent = getFriendlyErrorMessage(error.code);
                authError.classList.remove('hidden');
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.style.opacity = '1';
            }
        });

        googleSigninBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                showSnackbar("Google sign-in failed.");
                console.error(error);
            }
        });

        signoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        function getFriendlyErrorMessage(code) {
            switch (code) {
                case 'auth/user-not-found': return 'No account found with this email.';
                case 'auth/wrong-password': return 'Incorrect password.';
                case 'auth/email-already-in-use': return 'Email is already registered.';
                case 'auth/weak-password': return 'Password should be at least 6 characters.';
                case 'auth/invalid-credential': return 'Invalid email or password.';
                default: return 'An error occurred. Please try again.';
            }
        }

        // --- Auth State Listener ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                authScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                userEmailDisplay.textContent = user.email || 'Google User';
                startNotesListener();
            } else {
                appScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                if (unsubscribeNotes) {
                    unsubscribeNotes();
                    unsubscribeNotes = null;
                }
                notesGrid.innerHTML = '';
            }
        });

        // --- Firestore Operations ---
        function startNotesListener() {
            if (!currentUser) return;
            loadingIndicator.classList.remove('hidden');
            emptyState.classList.add('hidden');
            notesGrid.innerHTML = '';

            const notesRef = collection(db, 'users', currentUser.uid, 'notes');
            
            // Note: We fetch all documents and sort in memory to avoid needing compound indexes
            unsubscribeNotes = onSnapshot(notesRef, (snapshot) => {
                allNotes = [];
                snapshot.forEach(doc => {
                    allNotes.push({ id: doc.id, ...doc.data() });
                });

                // Sort descending by createdAt
                allNotes.sort((a, b) => {
                    const timeA = a.createdAt ? a.createdAt.toMillis() : Date.now();
                    const timeB = b.createdAt ? b.createdAt.toMillis() : Date.now();
                    return timeB - timeA;
                });

                renderNotes(allNotes);
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error listening to notes:", error);
                showSnackbar("Error loading notes.");
                loadingIndicator.classList.add('hidden');
            });
        }

        function renderNotes(notes) {
            notesGrid.innerHTML = '';
            if (notes.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            notes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card p-4 flex flex-col group relative overflow-hidden cursor-pointer h-56';
                
                const title = note.title || 'Untitled';
                const content = note.content || '';
                const date = note.createdAt ? new Date(note.createdAt.toMillis()).toLocaleDateString() : 'Just now';

                card.innerHTML = `
                    <div class="flex-grow overflow-hidden">
                        <h3 class="text-lg font-medium text-[#1c1b1f] mb-2 truncate">${escapeHtml(title)}</h3>
                        <p class="text-[#49454f] text-sm whitespace-pre-wrap line-clamp-5">${escapeHtml(content)}</p>
                    </div>
                    <div class="mt-4 pt-3 border-t border-[#e7e0ec] flex items-center justify-between text-xs text-[#79747e]">
                        <span>${date}</span>
                        <button class="delete-btn w-8 h-8 rounded-full hover:bg-[#eaddff] hover:text-[#b3261e] flex items-center justify-center transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100" title="Delete Note" data-id="${note.id}">
                            <span class="material-symbols-outlined text-lg pointer-events-none">delete</span>
                        </button>
                    </div>
                `;

                // Edit click event (clicking anywhere except delete button)
                card.addEventListener('click', (e) => {
                    if(!e.target.classList.contains('delete-btn')) {
                        openEditDialog(note);
                    }
                });

                // Delete click event
                const deleteBtn = card.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation(); // Prevent opening edit dialog
                    await deleteNote(note.id);
                });

                notesGrid.appendChild(card);
            });
        }

        function escapeHtml(unsafe) {
            return (unsafe || '').replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Dialog Actions ---
        addNoteFab.addEventListener('click', () => toggleDialog(true));
        closeDialogBtn.addEventListener('click', () => toggleDialog(false));
        
        // Close on overlay click
        noteDialog.addEventListener('click', (e) => {
            if (e.target === noteDialog) toggleDialog(false);
        });

        function openEditDialog(note) {
            noteTitleInput.value = note.title || '';
            noteContentInput.value = note.content || '';
            editNoteIdInput.value = note.id;
            toggleDialog(true, true);
        }

        saveNoteBtn.addEventListener('click', async () => {
            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();
            const noteId = editNoteIdInput.value;

            if (!title && !content) {
                toggleDialog(false);
                return;
            }

            if (!currentUser) return;
            
            saveNoteBtn.disabled = true;
            saveNoteBtn.textContent = 'Saving...';

            try {
                if (noteId) {
                    // Update existing note
                    const noteRef = doc(db, 'users', currentUser.uid, 'notes', noteId);
                    await updateDoc(noteRef, {
                        title,
                        content,
                        updatedAt: serverTimestamp()
                    });
                    showSnackbar("Note updated");
                } else {
                    // Create new note
                    await addDoc(collection(db, 'users', currentUser.uid, 'notes'), {
                        title,
                        content,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    showSnackbar("Note created");
                }
                toggleDialog(false);
            } catch (error) {
                console.error("Error saving note:", error);
                showSnackbar("Error saving note");
            } finally {
                saveNoteBtn.disabled = false;
                saveNoteBtn.textContent = 'Save Note';
            }
        });

        async function deleteNote(noteId) {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', noteId));
                showSnackbar("Note deleted");
            } catch (error) {
                console.error("Error deleting note:", error);
                showSnackbar("Failed to delete note");
            }
        }
    </script>
</body>
</html>

