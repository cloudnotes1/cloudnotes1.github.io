<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Notes - Google Material</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafd;
            color: #1f1f1f;
            margin: 0;
            overflow-x: hidden;
        }
        
        h1, h2, h3, .google-sans { font-family: 'Google Sans', sans-serif; }
        
        /* Material 3 Google Blue Color Tokens */
        .m3-surface-container { background-color: #f3f6fc; }
        .m3-primary { background-color: #0b57d0; color: #ffffff; }
        .m3-primary:hover { background-color: #0842a0; }
        .m3-primary-container { background-color: #d3e3fd; color: #041e49; }
        .m3-primary-container:hover { background-color: #b4cffb; }
        .m3-error { color: #b3261e; }
        
        /* M3 Ripple Effect */
        .ripple-surface {
            position: relative;
            overflow: hidden;
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-animation 600ms linear;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* M3 Inputs */
        .m3-input-wrapper {
            position: relative;
            background-color: #eef1f6;
            border-radius: 4px 4px 0 0;
            padding: 8px 16px;
            border-bottom: 1px solid #747775;
            transition: all 0.2s ease;
        }
        .m3-input-wrapper:focus-within {
            border-bottom: 2px solid #0b57d0;
            background-color: #e1e5ea;
        }
        .m3-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-size: 16px;
            color: #1f1f1f;
            padding-top: 12px;
            padding-bottom: 4px;
        }
        .m3-label {
            position: absolute;
            top: 8px;
            left: 16px;
            font-size: 12px;
            color: #444746;
            transition: all 0.2s ease;
            pointer-events: none;
            font-family: 'Google Sans', sans-serif;
        }
        .m3-input:placeholder-shown + .m3-label {
            top: 16px;
            font-size: 16px;
        }
        .m3-input:focus + .m3-label,
        .m3-input:not(:placeholder-shown) + .m3-label {
            top: 8px;
            font-size: 12px;
            color: #0b57d0;
        }

        /* M3 Toggle Switch */
        .m3-toggle {
            appearance: none;
            width: 52px;
            height: 32px;
            background: #e0e2e0;
            border-radius: 16px;
            position: relative;
            outline: none;
            cursor: pointer;
            transition: background 0.3s;
            border: 2px solid #747775;
        }
        .m3-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: #747775;
            border-radius: 50%;
            transition: transform 0.3s, background 0.3s;
        }
        .m3-toggle:checked {
            background: #0b57d0;
            border-color: #0b57d0;
        }
        .m3-toggle:checked::after {
            transform: translateX(20px);
            background: #ffffff;
        }

        /* FAB */
        .m3-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s, background-color 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .m3-fab:hover { box-shadow: 0 6px 12px 4px rgba(0,0,0,0.15); }
        .m3-fab:active { transform: scale(0.95); }

        /* Note Card */
        .note-card {
            border: 1px solid #c7c6ca;
            border-radius: 12px;
            transition: background-color 0.2s, box-shadow 0.2s;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
        }
        .note-card:hover {
            background-color: #f3f6fc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        /* M3 Chip (for attachments) */
        .m3-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 8px;
            border: 1px solid #747775;
            background-color: #ffffff;
            font-size: 14px;
            color: #1f1f1f;
            gap: 6px;
            transition: background-color 0.2s;
            max-width: 100%;
        }
        .m3-chip:hover { background-color: #eef1f6; }
        .m3-chip .chip-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        /* Snackbar */
        .snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #313033;
            color: #f4eff4;
            padding: 14px 16px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            font-family: 'Roboto', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .snackbar.show { opacity: 1; }

        /* Dialogs */
        .dialog-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
        }
        .dialog-content {
            background: #fdfbff;
            border-radius: 28px;
            box-shadow: 0 24px 38px 3px rgba(0,0,0,0.14);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #c7c6ca; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #747775; }
    </style>
</head>
<body class="antialiased">

    <!-- Snackbar -->
    <div id="snackbar" class="snackbar shadow-lg">
        <span id="snackbar-icon" class="material-symbols-outlined text-[18px] hidden"></span>
        <span id="snackbar-text"></span>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirm-dialog" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 dialog-overlay opacity-0 transition-opacity duration-200">
        <div class="dialog-content w-full max-w-sm flex flex-col transform scale-95 transition-transform duration-200" id="confirm-dialog-card">
            <div class="p-6 pb-4">
                <h3 id="confirm-title" class="text-2xl font-normal google-sans text-[#1f1f1f] mb-4">Confirm</h3>
                <p id="confirm-message" class="text-[#444746]"></p>
            </div>
            <div class="p-4 flex items-center justify-end gap-2">
                <button id="confirm-cancel-btn" class="ripple-surface px-5 py-2 rounded-full text-[#0b57d0] font-medium hover:bg-[#d3e3fd] transition-colors google-sans">Cancel</button>
                <button id="confirm-action-btn" class="ripple-surface px-5 py-2 rounded-full bg-[#ba1a1a] text-white font-medium hover:bg-[#93000a] transition-colors google-sans shadow-sm">Delete</button>
            </div>
        </div>
    </div>

    <!-- Share Dialog -->
    <div id="share-dialog" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 dialog-overlay opacity-0 transition-opacity duration-200">
        <div class="dialog-content w-full max-w-md flex flex-col transform scale-95 transition-transform duration-200" id="share-dialog-card">
            <div class="p-6 pb-4 max-h-[80vh] overflow-y-auto">
                <div class="flex items-center gap-3 mb-4">
                    <span class="material-symbols-outlined text-[#0b57d0] text-3xl">public</span>
                    <h3 class="text-2xl font-normal google-sans text-[#1f1f1f]">Share Note</h3>
                </div>
                
                <!-- Public Link Section -->
                <div class="flex items-center justify-between mb-4 mt-6">
                    <div>
                        <div class="font-medium text-[#1f1f1f]">Public Link</div>
                        <div class="text-sm text-[#444746]">Anyone with the link can view</div>
                    </div>
                    <input type="checkbox" id="share-toggle" class="m3-toggle">
                </div>

                <div id="share-link-container" class="hidden mt-4 animate-fade-in">
                    <div class="flex items-center gap-2 bg-[#eef1f6] p-2 rounded-lg border border-[#c7c6ca]">
                        <input type="text" id="share-link-input" readonly class="flex-grow bg-transparent border-none outline-none text-sm text-[#444746] px-2 truncate">
                        <button id="copy-link-btn" class="ripple-surface px-4 py-1.5 rounded-md m3-primary text-sm font-medium transition-colors google-sans whitespace-nowrap">Copy</button>
                    </div>
                </div>

                <!-- Collaborators Section -->
                <div class="mt-6 pt-6 border-t border-[#e0e2e0]">
                    <div class="font-medium text-[#1f1f1f] mb-1">Collaborators</div>
                    <div class="text-sm text-[#444746] mb-3">Add people to let them edit this note</div>
                    <div class="flex gap-2 mb-4">
                        <input type="email" id="collab-email-input" class="flex-grow bg-[#eef1f6] border border-[#c7c6ca] rounded-lg px-3 py-2 text-sm outline-none focus:border-[#0b57d0] transition-colors" placeholder="Email address">
                        <button id="add-collab-btn" class="ripple-surface px-4 py-2 rounded-md m3-primary text-sm font-medium transition-colors">Add</button>
                    </div>
                    <div id="collaborators-list" class="space-y-2">
                        <!-- Collaborators injected here -->
                    </div>
                </div>

            </div>
            <div class="p-4 flex items-center justify-end gap-2 border-t border-[#e0e2e0] bg-[#fdfbff] rounded-b-[28px]">
                <button id="share-close-btn" class="ripple-surface px-5 py-2 rounded-full text-[#0b57d0] font-medium hover:bg-[#d3e3fd] transition-colors google-sans">Done</button>
            </div>
        </div>
    </div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-[28px] p-8 w-full max-w-md shadow-sm border border-[#e0e2e0]">
            <div class="text-center mb-8">
                <span class="material-symbols-outlined text-5xl text-[#0b57d0] mb-2">note_stack</span>
                <h1 class="text-3xl font-normal google-sans" id="auth-title">Welcome Back</h1>
                <p class="text-[#444746] mt-2">Sign in to sync your notes</p>
            </div>

            <!-- Email/Password Form -->
            <form id="auth-form" class="space-y-4">
                <div class="m3-input-wrapper">
                    <input type="email" id="email" class="m3-input" placeholder=" " required>
                    <label class="m3-label">Email address</label>
                </div>
                <div class="m3-input-wrapper">
                    <input type="password" id="password" class="m3-input" placeholder=" " required>
                    <label class="m3-label">Password</label>
                </div>
                <div id="auth-error" class="text-sm m3-error hidden"></div>
                <button type="submit" id="auth-submit-btn" class="ripple-surface w-full m3-primary rounded-full py-2.5 font-medium mt-4 google-sans">
                    Sign In
                </button>
            </form>

            <div class="mt-4 flex items-center justify-between text-sm">
                <button id="toggle-auth-mode" class="text-[#0b57d0] font-medium hover:underline focus:outline-none google-sans">
                    Create an account instead
                </button>
            </div>

            <div class="relative flex py-6 items-center">
                <div class="flex-grow border-t border-[#c7c6ca]"></div>
                <span class="flex-shrink-0 mx-4 text-[#444746] text-sm">or</span>
                <div class="flex-grow border-t border-[#c7c6ca]"></div>
            </div>

            <!-- Google Sign In -->
            <button id="google-signin-btn" class="ripple-surface w-full border border-[#747775] rounded-full py-2.5 flex items-center justify-center gap-2 hover:bg-[#f3f6fc] transition-colors text-[#444746] font-medium google-sans">
                <svg viewBox="0 0 24 24" class="w-5 h-5 z-10">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                <span class="z-10 relative">Continue with Google</span>
            </button>
        </div>
    </div>

    <!-- MAIN APP SCREEN (HOME) -->
    <div id="app-screen" class="hidden min-h-screen flex flex-col">
        <header class="m3-surface-container px-4 py-3 flex items-center justify-between sticky top-0 z-10 shadow-sm border-b border-[#e0e2e0]">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[#0b57d0] text-3xl">edit_document</span>
                <h1 class="text-xl font-medium google-sans text-[#1f1f1f]">Cloud Notes</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="user-email-display" class="hidden sm:inline text-sm text-[#444746] font-medium"></span>
                <button id="signout-btn" class="ripple-surface w-10 h-10 rounded-full hover:bg-[#d3e3fd] flex items-center justify-center transition-colors text-[#444746]" title="Sign Out">
                    <span class="material-symbols-outlined pointer-events-none">logout</span>
                </button>
            </div>
        </header>

        <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <div id="loading-indicator" class="flex justify-center py-12 hidden">
                <span class="material-symbols-outlined animate-spin text-4xl text-[#0b57d0]">progress_activity</span>
            </div>
            <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
                <span class="material-symbols-outlined text-6xl text-[#c7c6ca] mb-4">note_add</span>
                <h2 class="text-xl text-[#1f1f1f] font-medium google-sans">No notes yet</h2>
                <p class="text-[#444746] mt-1">Tap the + button to create your first note.</p>
            </div>
        </main>

        <button id="add-note-fab" class="ripple-surface m3-fab m3-primary-container z-20 flex justify-center text-[#041e49]" title="Add Note">
            <span class="material-symbols-outlined text-[28px] pointer-events-none">add</span>
        </button>
    </div>

    <!-- FULL PAGE NOTE EDITOR -->
    <div id="editor-screen" class="hidden min-h-screen flex flex-col bg-[#f8fafd]">
        <header class="px-2 sm:px-4 py-2 flex items-center justify-between sticky top-0 z-10 bg-[#f8fafd] border-b border-[#e0e2e0]">
            <div class="flex items-center gap-2 flex-grow">
                <button id="back-btn" class="ripple-surface w-10 h-10 rounded-full hover:bg-[#e1e2e8] flex items-center justify-center transition-colors text-[#444746]" title="Back to notes">
                    <span class="material-symbols-outlined pointer-events-none">arrow_back</span>
                </button>
                <input type="text" id="editor-title" placeholder="Title" class="editor-title w-full max-w-2xl text-2xl font-medium bg-transparent border-none outline-none text-[#1f1f1f] placeholder-[#747775] ml-2 px-2 py-1">
            </div>
            <div class="flex items-center gap-2 pl-4">
                <button id="editor-share-btn" class="ripple-surface w-10 h-10 rounded-full hover:bg-[#e1e2e8] text-[#444746] flex items-center justify-center transition-colors hidden" title="Share Note">
                    <span class="material-symbols-outlined pointer-events-none">share</span>
                </button>
                <input type="file" id="attachment-input" class="hidden" multiple>
                <button id="attach-file-btn" class="ripple-surface w-10 h-10 rounded-full hover:bg-[#e1e2e8] text-[#444746] flex items-center justify-center transition-colors hidden" title="Attach file">
                    <span class="material-symbols-outlined pointer-events-none">attach_file</span>
                </button>
                <button id="editor-delete-btn" class="ripple-surface w-10 h-10 rounded-full hover:bg-[#ffdad6] text-[#ba1a1a] flex items-center justify-center transition-colors hidden" title="Delete Note">
                    <span class="material-symbols-outlined pointer-events-none">delete</span>
                </button>
                <button id="editor-save-btn" class="ripple-surface px-5 py-2 rounded-full m3-primary font-medium transition-colors text-sm shadow-sm google-sans flex items-center gap-2 hidden">
                    <span class="material-symbols-outlined text-[18px] pointer-events-none">save</span>
                    <span class="hidden sm:inline pointer-events-none">Save</span>
                </button>
            </div>
        </header>

        <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-4xl mx-auto w-full flex flex-col">
            <!-- Information Banners -->
            <div id="read-only-banner" class="hidden bg-[#eef1f6] text-[#444746] px-4 py-2 rounded-lg mb-4 text-sm flex items-center gap-2 border border-[#c7c6ca]">
                <span class="material-symbols-outlined text-[18px]">visibility</span>
                You are viewing a shared note in read-only mode.
            </div>
            <div id="collab-banner" class="hidden bg-[#d3e3fd] text-[#041e49] px-4 py-2 rounded-lg mb-4 text-sm font-medium flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px]">group</span>
                You are editing this note as a collaborator.
            </div>

            <textarea id="editor-content" placeholder="Start typing your note here..." class="flex-grow w-full min-h-[300px] resize-none bg-transparent border-none outline-none text-[#1f1f1f] placeholder-[#747775] text-base leading-relaxed"></textarea>
            
            <div id="attachments-container" class="mt-8 hidden">
                <h3 class="text-sm font-medium text-[#444746] mb-3 uppercase tracking-wider google-sans">Attachments</h3>
                <div id="attachments-list" class="flex flex-wrap gap-2"></div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, deleteDoc, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfCHOpzMc4ER7cRnZlnGzf5t3kh9EVQ44",
            authDomain: "cloudnotes-bd76c.firebaseapp.com",
            projectId: "cloudnotes-bd76c",
            storageBucket: "cloudnotes-bd76c.firebasestorage.app",
            messagingSenderId: "625498466879",
            appId: "1:625498466879:web:af13aeeac06d532de9e68a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let isSignUpMode = false;
        let unsubscribeNotes = null;
        let allNotes = [];
        let currentEditingNoteId = null; 
        let currentOwnerId = null; 
        let currentAttachments = [];
        let currentNoteIsPublic = false;
        let currentCollaborators = [];
        let isReadOnlyMode = false;

        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const editorScreen = document.getElementById('editor-screen');
        
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const authError = document.getElementById('auth-error');
        
        const userEmailDisplay = document.getElementById('user-email-display');
        const signoutBtn = document.getElementById('signout-btn');
        const notesGrid = document.getElementById('notes-grid');
        const emptyState = document.getElementById('empty-state');
        const loadingIndicator = document.getElementById('loading-indicator');
        const addNoteFab = document.getElementById('add-note-fab');
        
        const confirmDialog = document.getElementById('confirm-dialog');
        const confirmDialogCard = document.getElementById('confirm-dialog-card');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');

        const shareDialog = document.getElementById('share-dialog');
        const shareDialogCard = document.getElementById('share-dialog-card');
        const shareToggle = document.getElementById('share-toggle');
        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLinkInput = document.getElementById('share-link-input');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const shareCloseBtn = document.getElementById('share-close-btn');
        const collabEmailInput = document.getElementById('collab-email-input');
        const addCollabBtn = document.getElementById('add-collab-btn');
        const collaboratorsList = document.getElementById('collaborators-list');

        const backBtn = document.getElementById('back-btn');
        const editorTitleInput = document.getElementById('editor-title');
        const editorContentInput = document.getElementById('editor-content');
        const editorSaveBtn = document.getElementById('editor-save-btn');
        const editorDeleteBtn = document.getElementById('editor-delete-btn');
        const editorShareBtn = document.getElementById('editor-share-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const attachmentInput = document.getElementById('attachment-input');
        const attachmentsContainer = document.getElementById('attachments-container');
        const attachmentsList = document.getElementById('attachments-list');
        
        const readOnlyBanner = document.getElementById('read-only-banner');
        const collabBanner = document.getElementById('collab-banner');
        
        const snackbar = document.getElementById('snackbar');
        const snackbarText = document.getElementById('snackbar-text');
        const snackbarIcon = document.getElementById('snackbar-icon');

        // M3 Ripple Effect Logic
        function applyRipple(e, target, isTouch = false) {
            const circle = document.createElement('span');
            const diameter = Math.max(target.clientWidth, target.clientHeight);
            const radius = diameter / 2;

            const rect = target.getBoundingClientRect();
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${clientX - rect.left - radius}px`;
            circle.style.top = `${clientY - rect.top - radius}px`;
            circle.classList.add('ripple');

            if (target.classList.contains('m3-primary') || target.classList.contains('bg-[#ba1a1a]')) {
                circle.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
            } else if (target.classList.contains('m3-primary-container')) {
                circle.style.backgroundColor = 'rgba(11, 87, 208, 0.2)';
            } else {
                circle.style.backgroundColor = 'rgba(0, 0, 0, 0.08)';
            }

            const existingRipple = target.querySelector('.ripple');
            if (existingRipple) existingRipple.remove();

            target.appendChild(circle);
            
            // Cleanup after animation completes
            setTimeout(() => { if (circle && circle.parentNode) circle.remove(); }, 600);
        }

        document.addEventListener('mousedown', function(e) {
            const target = e.target.closest('.ripple-surface');
            if (target) applyRipple(e, target);
        });

        document.addEventListener('touchstart', function(e) {
            const target = e.target.closest('.ripple-surface');
            if (target) applyRipple(e, target, true);
        }, {passive: true});


        // UI Utilities
        function showSnackbar(message, isSpinner = false) {
            snackbarText.textContent = message;
            if (isSpinner) {
                snackbarIcon.textContent = 'progress_activity';
                snackbarIcon.classList.add('animate-spin');
                snackbarIcon.classList.remove('hidden');
            } else {
                snackbarIcon.classList.add('hidden');
                snackbarIcon.classList.remove('animate-spin');
            }
            snackbar.classList.add('show');
            if (!isSpinner) setTimeout(() => snackbar.classList.remove('show'), 3000);
        }

        function hideSnackbar() { snackbar.classList.remove('show'); }

        function escapeHtml(unsafe) {
            return (unsafe || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function formatBytes(bytes, decimals = 1) {
            if (!+bytes) return '0 Bytes';
            const k = 1024, dm = decimals < 0 ? 0 : decimals, sizes = ['Bytes', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function showConfirm(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmDialog.classList.remove('hidden');
            void confirmDialog.offsetWidth;
            confirmDialog.classList.remove('opacity-0');
            confirmDialogCard.classList.remove('scale-95');

            confirmCancelBtn.onclick = () => closeDialog(confirmDialog, confirmDialogCard);
            confirmActionBtn.onclick = () => { closeDialog(confirmDialog, confirmDialogCard); onConfirm(); };
        }

        function closeDialog(dialog, card) {
            dialog.classList.add('opacity-0');
            card.classList.add('scale-95');
            setTimeout(() => dialog.classList.add('hidden'), 200);
        }

        // Routing
        function handleRouting() {
            const hash = window.location.hash;
            
            if (hash.startsWith('#shared/')) {
                authScreen.classList.add('hidden');
                appScreen.classList.add('hidden');
                editorScreen.classList.remove('hidden');
                const parts = hash.replace('#shared/', '').split('/');
                openEditor(parts[1], parts[0]); 
                return;
            }

            if (!currentUser) {
                appScreen.classList.add('hidden');
                editorScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                return;
            }

            authScreen.classList.add('hidden');

            if (hash.startsWith('#note/')) {
                const noteId = hash.replace('#note/', '');
                openEditor(noteId);
            } else {
                editorScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                currentEditingNoteId = null;
                currentOwnerId = null;
                currentAttachments = [];
                currentCollaborators = [];
                isReadOnlyMode = false;
            }
        }
        window.addEventListener('hashchange', handleRouting);

        // Auth
        toggleAuthModeBtn.addEventListener('click', () => {
            isSignUpMode = !isSignUpMode;
            authTitle.textContent = isSignUpMode ? 'Create Account' : 'Welcome Back';
            authSubmitBtn.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            toggleAuthModeBtn.textContent = isSignUpMode ? 'Sign in instead' : 'Create an account instead';
            authError.classList.add('hidden');
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.classList.add('hidden');
            authSubmitBtn.disabled = true; authSubmitBtn.style.opacity = '0.7';
            try {
                if (isSignUpMode) await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
                else await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
            } catch (error) {
                authError.textContent = 'Invalid email or password.';
                authError.classList.remove('hidden');
            } finally {
                authSubmitBtn.disabled = false; authSubmitBtn.style.opacity = '1';
            }
        });

        googleSigninBtn.addEventListener('click', async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { showSnackbar("Google sign-in failed."); }
        });

        signoutBtn.addEventListener('click', () => { signOut(auth); window.location.hash = ''; });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                userEmailDisplay.textContent = user.email || 'Google User';
                startNotesListener();
            } else {
                if (unsubscribeNotes) { unsubscribeNotes(); unsubscribeNotes = null; }
                notesGrid.innerHTML = '';
            }
            handleRouting(); 
        });

        // Firestore List
        function startNotesListener() {
            if (!currentUser) return;
            loadingIndicator.classList.remove('hidden'); emptyState.classList.add('hidden');
            const notesRef = collection(db, 'users', currentUser.uid, 'notes');
            
            unsubscribeNotes = onSnapshot(notesRef, (snapshot) => {
                allNotes = [];
                snapshot.forEach(doc => allNotes.push({ id: doc.id, ...doc.data() }));
                allNotes.sort((a, b) => {
                    const timeA = a.updatedAt ? a.updatedAt.toMillis() : (a.createdAt ? a.createdAt.toMillis() : 0);
                    const timeB = b.updatedAt ? b.updatedAt.toMillis() : (b.createdAt ? b.createdAt.toMillis() : 0);
                    return timeB - timeA;
                });
                if (!window.location.hash.startsWith('#note/') && !window.location.hash.startsWith('#shared/')) renderNotes(allNotes);
                loadingIndicator.classList.add('hidden');
            });
        }

        function renderNotes(notes) {
            notesGrid.innerHTML = '';
            if (notes.length === 0) { emptyState.classList.remove('hidden'); return; }
            emptyState.classList.add('hidden');

            notes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card ripple-surface p-4 h-56 group relative cursor-pointer';
                const title = note.title || 'Untitled Note';
                const content = note.content || '';
                const date = note.updatedAt ? new Date(note.updatedAt.toMillis()).toLocaleDateString() : 'Draft';
                const hasAttachments = note.attachments && note.attachments.length > 0;
                const isPublic = note.isPublic === true;
                const isSharedCollab = note.collaborators && note.collaborators.length > 0;

                let iconHtml = '';
                if (isPublic) iconHtml += `<span class="material-symbols-outlined text-[18px]" title="Publicly shared">public</span>`;
                else if (isSharedCollab) iconHtml += `<span class="material-symbols-outlined text-[18px]" title="Shared with collaborators">group</span>`;
                if (hasAttachments) iconHtml += `<span class="material-symbols-outlined text-[18px]" title="${note.attachments.length} attachment(s)">attach_file</span>`;

                card.innerHTML = `
                    <div class="flex-grow overflow-hidden relative z-10 pointer-events-none">
                        <h3 class="text-lg font-medium text-[#1f1f1f] mb-2 truncate google-sans pr-10">${escapeHtml(title)}</h3>
                        <div class="absolute top-0 right-0 flex gap-1 text-[#747775]">
                            ${iconHtml}
                        </div>
                        <p class="text-[#444746] text-sm whitespace-pre-wrap line-clamp-5">${escapeHtml(content)}</p>
                    </div>
                    <div class="mt-4 pt-3 border-t border-[#e0e2e0] flex items-center justify-between text-xs text-[#747775] z-10 relative">
                        <span>${date}</span>
                        <button class="delete-btn ripple-surface w-8 h-8 rounded-full hover:bg-[#ffdad6] hover:text-[#ba1a1a] flex items-center justify-center transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100" title="Delete Note" data-id="${note.id}">
                            <span class="material-symbols-outlined text-[18px] pointer-events-none">delete</span>
                        </button>
                    </div>
                `;
                card.addEventListener('click', (e) => { if(!e.target.closest('.delete-btn')) window.location.hash = `#note/${note.id}`; });
                card.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirm("Delete Note", "Are you sure you want to delete this note? This will also delete any attached files.", async () => await deleteNote(note.id, note.attachments));
                });
                notesGrid.appendChild(card);
            });
        }

        // Editor
        addNoteFab.addEventListener('click', () => window.location.hash = '#note/new');
        backBtn.addEventListener('click', () => window.location.hash = '#home');

        async function openEditor(noteId, ownerId = null) {
            appScreen.classList.add('hidden');
            editorScreen.classList.remove('hidden');
            
            currentOwnerId = ownerId || (currentUser ? currentUser.uid : null);
            
            readOnlyBanner.classList.add('hidden');
            collabBanner.classList.add('hidden');
            
            if (noteId === 'new') {
                currentEditingNoteId = null;
                editorTitleInput.value = ''; editorContentInput.value = '';
                currentAttachments = []; 
                currentNoteIsPublic = false;
                currentCollaborators = [];
                isReadOnlyMode = false;
                renderAttachments();
                
                editorDeleteBtn.classList.add('hidden');
                editorShareBtn.classList.add('hidden'); 
                editorSaveBtn.classList.remove('hidden');
                attachFileBtn.classList.remove('hidden');
                editorTitleInput.readOnly = false;
                editorContentInput.readOnly = false;
                editorTitleInput.focus();
            } else {
                currentEditingNoteId = noteId;
                editorTitleInput.value = 'Loading...'; editorContentInput.value = 'Loading...';
                
                try {
                    const docRef = doc(db, 'users', currentOwnerId, 'notes', noteId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = {id: docSnap.id, ...docSnap.data()};
                        
                        const isOwner = currentUser && currentUser.uid === currentOwnerId;
                        const isCollab = currentUser && data.collaborators && data.collaborators.includes(currentUser.email);
                        const isPublic = data.isPublic === true;

                        if (isOwner) {
                            isReadOnlyMode = false;
                            editorDeleteBtn.classList.remove('hidden');
                            editorShareBtn.classList.remove('hidden');
                        } else if (isCollab) {
                            isReadOnlyMode = false;
                            collabBanner.classList.remove('hidden');
                            editorDeleteBtn.classList.add('hidden');
                            editorShareBtn.classList.add('hidden'); 
                        } else if (isPublic) {
                            isReadOnlyMode = true;
                            readOnlyBanner.classList.remove('hidden');
                        } else {
                            showSnackbar("You do not have access to this note.");
                            window.location.hash = '#home';
                            return;
                        }

                        if (isReadOnlyMode) {
                            editorSaveBtn.classList.add('hidden');
                            attachFileBtn.classList.add('hidden');
                            editorTitleInput.readOnly = true;
                            editorContentInput.readOnly = true;
                        } else {
                            editorSaveBtn.classList.remove('hidden');
                            attachFileBtn.classList.remove('hidden');
                            editorTitleInput.readOnly = false;
                            editorContentInput.readOnly = false;
                        }

                        populateEditor(data);
                    } else {
                        showSnackbar("Note not found"); window.location.hash = '#home';
                    }
                } catch (error) {
                    console.error(error);
                    showSnackbar("Error loading note. Access denied or network issue."); 
                    window.location.hash = '#home';
                }
            }
        }

        function populateEditor(noteData) {
            editorTitleInput.value = noteData.title || '';
            editorContentInput.value = noteData.content || '';
            currentAttachments = noteData.attachments || [];
            currentNoteIsPublic = noteData.isPublic || false;
            currentCollaborators = noteData.collaborators || [];
            renderAttachments();
        }

        editorSaveBtn.addEventListener('click', () => performSave(true));

        async function performSave(manualTrigger = false) {
            if (isReadOnlyMode || !currentUser) return;
            const title = editorTitleInput.value.trim(); const content = editorContentInput.value.trim();
            if (!title && !content && currentAttachments.length === 0) {
                if(manualTrigger) showSnackbar("Cannot save an empty note");
                return;
            }

            if (manualTrigger) {
                editorSaveBtn.disabled = true;
                editorSaveBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">progress_activity</span><span class="hidden sm:inline">Saving</span>';
            }

            try {
                const noteRef = currentEditingNoteId 
                    ? doc(db, 'users', currentOwnerId, 'notes', currentEditingNoteId) 
                    : doc(collection(db, 'users', currentUser.uid, 'notes'));
                
                if (!currentEditingNoteId) {
                    currentEditingNoteId = noteRef.id;
                    currentOwnerId = currentUser.uid;
                    window.history.replaceState(null, '', `#note/${currentEditingNoteId}`);
                    editorDeleteBtn.classList.remove('hidden');
                    editorShareBtn.classList.remove('hidden');
                }

                await setDoc(noteRef, { 
                    title, 
                    content, 
                    attachments: currentAttachments, 
                    isPublic: currentNoteIsPublic, 
                    collaborators: currentCollaborators,
                    updatedAt: serverTimestamp() 
                }, { merge: true });
                
                if (manualTrigger) { showSnackbar("Note saved successfully"); }
            } catch (error) {
                console.error("Save error:", error);
                if(manualTrigger) showSnackbar("Error saving note");
            } finally {
                if (manualTrigger) { editorSaveBtn.disabled = false; editorSaveBtn.innerHTML = '<span class="material-symbols-outlined text-[18px] pointer-events-none">save</span><span class="hidden sm:inline pointer-events-none">Save</span>'; }
            }
        }

        // Sharing & Collaboration
        editorShareBtn.addEventListener('click', async () => {
            if (!currentEditingNoteId) await performSave(false);
            
            shareToggle.checked = currentNoteIsPublic;
            shareLinkContainer.classList.toggle('hidden', !currentNoteIsPublic);
            shareLinkInput.value = `${window.location.origin}${window.location.pathname}#shared/${currentOwnerId}/${currentEditingNoteId}`;
            
            renderCollaboratorsUI();

            shareDialog.classList.remove('hidden');
            void shareDialog.offsetWidth;
            shareDialog.classList.remove('opacity-0');
            shareDialogCard.classList.remove('scale-95');
        });

        shareToggle.addEventListener('change', async (e) => {
            currentNoteIsPublic = e.target.checked;
            shareLinkContainer.classList.toggle('hidden', !currentNoteIsPublic);
            if (currentUser && currentEditingNoteId) {
                await updateDoc(doc(db, 'users', currentOwnerId, 'notes', currentEditingNoteId), { isPublic: currentNoteIsPublic });
                showSnackbar(currentNoteIsPublic ? "Note is now public" : "Note is now private");
            }
        });

        copyLinkBtn.addEventListener('click', () => {
            shareLinkInput.select();
            shareLinkInput.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(shareLinkInput.value).then(() => showSnackbar("Link copied!"));
            } catch(e) {
                document.execCommand("copy");
                showSnackbar("Link copied!");
            }
        });

        // Collaborators Logic
        function renderCollaboratorsUI() {
            collaboratorsList.innerHTML = '';
            
            if (currentCollaborators.length === 0) {
                collaboratorsList.innerHTML = `<div class="text-sm text-[#747775] italic">No collaborators added yet.</div>`;
                return;
            }

            currentCollaborators.forEach((email, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-[#f3f6fc] px-3 py-2 rounded-lg text-sm text-[#1f1f1f] border border-[#e0e2e0]';
                div.innerHTML = `
                    <span class="truncate">${escapeHtml(email)}</span>
                    <button class="remove-collab-btn ripple-surface w-6 h-6 rounded-full flex items-center justify-center hover:bg-[#ffdad6] text-[#ba1a1a] transition-colors" data-index="${index}" title="Remove collaborator">
                        <span class="material-symbols-outlined text-[16px] pointer-events-none">close</span>
                    </button>
                `;
                collaboratorsList.appendChild(div);
            });

            document.querySelectorAll('.remove-collab-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const idx = e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index');
                    const removedEmail = currentCollaborators[idx];
                    currentCollaborators.splice(idx, 1);
                    renderCollaboratorsUI();
                    await performSave(false);
                    showSnackbar(`Removed ${removedEmail}`);
                });
            });
        }

        addCollabBtn.addEventListener('click', async () => {
            const email = collabEmailInput.value.trim().toLowerCase();
            
            if (!email) return;
            
            // Basic email validation
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showSnackbar("Please enter a valid email.");
                return;
            }
            if (email === currentUser.email) {
                showSnackbar("You are already the owner.");
                collabEmailInput.value = '';
                return;
            }
            if (currentCollaborators.includes(email)) {
                showSnackbar("User is already a collaborator.");
                collabEmailInput.value = '';
                return;
            }

            currentCollaborators.push(email);
            collabEmailInput.value = '';
            renderCollaboratorsUI();
            await performSave(false);
            showSnackbar(`Invited ${email}`);
        });

        shareCloseBtn.addEventListener('click', () => closeDialog(shareDialog, shareDialogCard));

        // Attachments
        attachFileBtn.addEventListener('click', () => attachmentInput.click());
        attachmentInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) { await uploadAttachments(e.target.files); attachmentInput.value = ''; }
        });

        async function uploadAttachments(files) {
            if (!currentUser || isReadOnlyMode) return;
            if (!currentEditingNoteId) await performSave(false);
            showSnackbar(`Uploading ${files.length} file(s)...`, true);

            for (const file of files) {
                const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const filePath = `users/${currentOwnerId}/notes/${currentEditingNoteId}/${Date.now()}_${safeName}`;
                try {
                    const snapshot = await uploadBytesResumable(ref(storage, filePath), file);
                    currentAttachments.push({ name: file.name, url: await getDownloadURL(snapshot.ref), path: filePath, type: file.type, size: file.size });
                    renderAttachments();
                } catch (error) { 
                    console.error(error);
                    showSnackbar(`Failed to upload ${file.name}`); 
                }
            }
            hideSnackbar(); await performSave(false);
        }

        function renderAttachments() {
            if (currentAttachments.length === 0) {
                attachmentsContainer.classList.add('hidden'); attachmentsList.innerHTML = ''; return;
            }
            attachmentsContainer.classList.remove('hidden'); attachmentsList.innerHTML = '';

            currentAttachments.forEach((att, index) => {
                const isImage = att.type?.startsWith('image/');
                const chip = document.createElement('div');
                chip.className = 'm3-chip';
                chip.innerHTML = `
                    <span class="material-symbols-outlined text-[16px] text-[#0b57d0]">${isImage ? 'image' : 'description'}</span>
                    <a href="${att.url}" target="_blank" rel="noopener noreferrer" class="chip-text hover:underline text-[#0b57d0]" title="${escapeHtml(att.name)} (${formatBytes(att.size)})">${escapeHtml(att.name)}</a>
                    ${!isReadOnlyMode ? `<button class="remove-att-btn ripple-surface w-5 h-5 rounded-full flex items-center justify-center hover:bg-[#e1e2e8] text-[#444746] ml-1 transition-colors" data-index="${index}" title="Remove file"><span class="material-symbols-outlined text-[14px] pointer-events-none">close</span></button>` : ''}
                `;
                attachmentsList.appendChild(chip);
            });

            if (!isReadOnlyMode) {
                document.querySelectorAll('.remove-att-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    const idx = e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index');
                    removeAttachment(idx);
                }));
            }
        }

        async function removeAttachment(index) {
            const att = currentAttachments[index];
            if (!att || isReadOnlyMode) return;
            showConfirm("Remove Attachment", `Remove "${att.name}" from this note?`, async () => {
                try { await deleteObject(ref(storage, att.path)); } catch (error) { console.warn("Delete error:", error); }
                currentAttachments.splice(index, 1);
                renderAttachments(); await performSave(false);
            });
        }

        // Deletion (Owner only)
        editorDeleteBtn.addEventListener('click', () => {
            if (currentEditingNoteId && !isReadOnlyMode && currentUser.uid === currentOwnerId) {
                showConfirm("Delete Note", "Are you sure you want to delete this note? This will also delete any attached files.", async () => {
                    await deleteNote(currentEditingNoteId, currentAttachments); window.location.hash = '#home';
                });
            }
        });

        async function deleteNote(noteId, attachmentsArray) {
            if (!currentUser) return;
            
            // Determine the owner. If on the homepage, currentOwnerId is null, meaning the user is viewing their own notes.
            const ownerId = currentOwnerId || currentUser.uid;
            
            // Only allow deletion if the user actually owns the note
            if (currentUser.uid !== ownerId) return;

            try {
                if (attachmentsArray && attachmentsArray.length > 0) {
                    for (const att of attachmentsArray) {
                        try { await deleteObject(ref(storage, att.path)); } catch (e) {}
                    }
                }
                await deleteDoc(doc(db, 'users', ownerId, 'notes', noteId));
                showSnackbar("Note deleted");
            } catch (error) { 
                showSnackbar("Failed to delete note"); 
            }
        }
    </script>
</body>
</html>


