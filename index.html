<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Notes - Google Material</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafd; /* Google M3 Surface */
            color: #1f1f1f; /* Google M3 On Surface */
            margin: 0;
            overflow-x: hidden;
        }
        
        h1, h2, h3, .google-sans {
            font-family: 'Google Sans', sans-serif;
        }
        
        /* Material 3 Google Blue Color Tokens */
        .m3-surface-container { background-color: #f3f6fc; }
        .m3-primary { background-color: #0b57d0; color: #ffffff; }
        .m3-primary:hover { background-color: #0842a0; }
        .m3-primary-container { background-color: #d3e3fd; color: #041e49; }
        .m3-primary-container:hover { background-color: #b4cffb; }
        .m3-error { color: #b3261e; }
        
        /* M3 Inputs */
        .m3-input-wrapper {
            position: relative;
            background-color: #eef1f6;
            border-radius: 4px 4px 0 0;
            padding: 8px 16px;
            border-bottom: 1px solid #747775;
            transition: all 0.2s ease;
        }
        .m3-input-wrapper:focus-within {
            border-bottom: 2px solid #0b57d0;
            background-color: #e1e5ea;
        }
        .m3-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-size: 16px;
            color: #1f1f1f;
            padding-top: 12px;
            padding-bottom: 4px;
        }
        .m3-label {
            position: absolute;
            top: 8px;
            left: 16px;
            font-size: 12px;
            color: #444746;
            transition: all 0.2s ease;
            pointer-events: none;
            font-family: 'Google Sans', sans-serif;
        }
        .m3-input:placeholder-shown + .m3-label {
            top: 16px;
            font-size: 16px;
        }
        .m3-input:focus + .m3-label,
        .m3-input:not(:placeholder-shown) + .m3-label {
            top: 8px;
            font-size: 12px;
            color: #0b57d0;
        }

        /* FAB */
        .m3-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s, background-color 0.2s, transform 0.2s;
            cursor: pointer;
        }
        .m3-fab:hover {
            box-shadow: 0 6px 12px 4px rgba(0,0,0,0.15);
        }
        .m3-fab:active {
            transform: scale(0.95);
        }

        /* Note Card */
        .note-card {
            border: 1px solid #c7c6ca;
            border-radius: 12px;
            transition: background-color 0.2s, box-shadow 0.2s;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
        }
        .note-card:hover {
            background-color: #f3f6fc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        /* M3 Chip (for attachments) */
        .m3-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 8px;
            border: 1px solid #747775;
            background-color: #ffffff;
            font-size: 14px;
            color: #1f1f1f;
            gap: 6px;
            transition: background-color 0.2s;
            max-width: 100%;
        }
        .m3-chip:hover {
            background-color: #eef1f6;
        }
        .m3-chip .chip-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        /* Snackbar */
        .snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #313033;
            color: #f4eff4;
            padding: 14px 16px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            font-family: 'Roboto', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .snackbar.show {
            opacity: 1;
        }

        /* Editor specific inputs */
        .editor-title {
            font-family: 'Google Sans', sans-serif;
        }

        /* Custom Modal / Dialog for Confirmations */
        .dialog-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
        }
        .dialog-content {
            background: #fdfbff;
            border-radius: 28px;
            box-shadow: 0 24px 38px 3px rgba(0,0,0,0.14);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #c7c6ca; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #747775; }
    </style>
</head>
<body class="antialiased">

    <!-- Snackbar for notifications -->
    <div id="snackbar" class="snackbar shadow-lg">
        <span id="snackbar-icon" class="material-symbols-outlined text-[18px] hidden"></span>
        <span id="snackbar-text"></span>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirm-dialog" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 dialog-overlay opacity-0 transition-opacity duration-200">
        <div class="dialog-content w-full max-w-sm flex flex-col transform scale-95 transition-transform duration-200" id="confirm-dialog-card">
            <div class="p-6 pb-4">
                <h3 id="confirm-title" class="text-2xl font-normal google-sans text-[#1f1f1f] mb-4">Confirm</h3>
                <p id="confirm-message" class="text-[#444746]"></p>
            </div>
            <div class="p-4 flex items-center justify-end gap-2">
                <button id="confirm-cancel-btn" class="px-5 py-2 rounded-full text-[#0b57d0] font-medium hover:bg-[#d3e3fd] transition-colors google-sans">Cancel</button>
                <button id="confirm-action-btn" class="px-5 py-2 rounded-full bg-[#ba1a1a] text-white font-medium hover:bg-[#93000a] transition-colors google-sans shadow-sm">Delete</button>
            </div>
        </div>
    </div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-[28px] p-8 w-full max-w-md shadow-sm border border-[#e0e2e0]">
            <div class="text-center mb-8">
                <span class="material-symbols-outlined text-5xl text-[#0b57d0] mb-2">note_stack</span>
                <h1 class="text-3xl font-normal google-sans" id="auth-title">Welcome Back</h1>
                <p class="text-[#444746] mt-2">Sign in to sync your notes</p>
            </div>

            <!-- Email/Password Form -->
            <form id="auth-form" class="space-y-4">
                <div class="m3-input-wrapper">
                    <input type="email" id="email" class="m3-input" placeholder=" " required>
                    <label class="m3-label">Email address</label>
                </div>
                <div class="m3-input-wrapper">
                    <input type="password" id="password" class="m3-input" placeholder=" " required>
                    <label class="m3-label">Password</label>
                </div>
                
                <div id="auth-error" class="text-sm m3-error hidden"></div>

                <button type="submit" id="auth-submit-btn" class="w-full m3-primary rounded-full py-2.5 font-medium mt-4 google-sans">
                    Sign In
                </button>
            </form>

            <div class="mt-4 flex items-center justify-between text-sm">
                <button id="toggle-auth-mode" class="text-[#0b57d0] font-medium hover:underline focus:outline-none google-sans">
                    Create an account instead
                </button>
            </div>

            <div class="relative flex py-6 items-center">
                <div class="flex-grow border-t border-[#c7c6ca]"></div>
                <span class="flex-shrink-0 mx-4 text-[#444746] text-sm">or</span>
                <div class="flex-grow border-t border-[#c7c6ca]"></div>
            </div>

            <!-- Google Sign In -->
            <button id="google-signin-btn" class="w-full border border-[#747775] rounded-full py-2.5 flex items-center justify-center gap-2 hover:bg-[#f3f6fc] transition-colors text-[#444746] font-medium google-sans">
                <svg viewBox="0 0 24 24" class="w-5 h-5">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- MAIN APP SCREEN (HOME) -->
    <div id="app-screen" class="hidden min-h-screen flex flex-col">
        <!-- App Bar -->
        <header class="m3-surface-container px-4 py-3 flex items-center justify-between sticky top-0 z-10 shadow-sm border-b border-[#e0e2e0]">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[#0b57d0] text-3xl">edit_document</span>
                <h1 class="text-xl font-medium google-sans text-[#1f1f1f]">Cloud Notes</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="user-email-display" class="hidden sm:inline text-sm text-[#444746] font-medium"></span>
                <button id="signout-btn" class="w-10 h-10 rounded-full hover:bg-[#d3e3fd] flex items-center justify-center transition-colors text-[#444746]" title="Sign Out">
                    <span class="material-symbols-outlined">logout</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="flex justify-center py-12 hidden">
                <span class="material-symbols-outlined animate-spin text-4xl text-[#0b57d0]">progress_activity</span>
            </div>

            <!-- Notes Grid -->
            <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Notes will be injected here via JS -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
                <span class="material-symbols-outlined text-6xl text-[#c7c6ca] mb-4">note_add</span>
                <h2 class="text-xl text-[#1f1f1f] font-medium google-sans">No notes yet</h2>
                <p class="text-[#444746] mt-1">Tap the + button to create your first note.</p>
            </div>
        </main>

        <!-- Floating Action Button -->
        <button id="add-note-fab" class="m3-fab m3-primary-container z-20 flex justify-center text-[#041e49]" title="Add Note">
            <span class="material-symbols-outlined text-[28px]">add</span>
        </button>
    </div>

    <!-- FULL PAGE NOTE EDITOR -->
    <div id="editor-screen" class="hidden min-h-screen flex flex-col bg-[#f8fafd]">
        <!-- Editor App Bar -->
        <header class="px-2 sm:px-4 py-2 flex items-center justify-between sticky top-0 z-10 bg-[#f8fafd] border-b border-[#e0e2e0]">
            <div class="flex items-center gap-2 flex-grow">
                <button id="back-btn" class="w-10 h-10 rounded-full hover:bg-[#e1e2e8] flex items-center justify-center transition-colors text-[#444746]" title="Back to notes">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <input type="text" id="editor-title" placeholder="Title" class="editor-title w-full max-w-2xl text-2xl font-medium bg-transparent border-none outline-none text-[#1f1f1f] placeholder-[#747775] ml-2 px-2 py-1">
            </div>
            <div class="flex items-center gap-2 pl-4">
                <input type="file" id="attachment-input" class="hidden" multiple>
                <button id="attach-file-btn" class="w-10 h-10 rounded-full hover:bg-[#e1e2e8] text-[#444746] flex items-center justify-center transition-colors" title="Attach file">
                    <span class="material-symbols-outlined">attach_file</span>
                </button>
                <button id="editor-delete-btn" class="w-10 h-10 rounded-full hover:bg-[#ffdad6] text-[#ba1a1a] flex items-center justify-center transition-colors hidden" title="Delete Note">
                    <span class="material-symbols-outlined">delete</span>
                </button>
                <button id="editor-save-btn" class="px-5 py-2 rounded-full m3-primary font-medium transition-colors text-sm shadow-sm google-sans flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">save</span>
                    <span class="hidden sm:inline">Save</span>
                </button>
            </div>
        </header>

        <!-- Editor Canvas -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-4xl mx-auto w-full flex flex-col">
            <textarea id="editor-content" placeholder="Start typing your note here..." class="flex-grow w-full min-h-[300px] resize-none bg-transparent border-none outline-none text-[#1f1f1f] placeholder-[#747775] text-base leading-relaxed"></textarea>
            
            <!-- Attachments Area -->
            <div id="attachments-container" class="mt-8 hidden">
                <h3 class="text-sm font-medium text-[#444746] mb-3 uppercase tracking-wider google-sans">Attachments</h3>
                <div id="attachments-list" class="flex flex-wrap gap-2">
                    <!-- Attachment chips injected here -->
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            deleteDoc, 
            doc, 
            getDoc,
            setDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfCHOpzMc4ER7cRnZlnGzf5t3kh9EVQ44",
            authDomain: "cloudnotes-bd76c.firebaseapp.com",
            projectId: "cloudnotes-bd76c",
            storageBucket: "cloudnotes-bd76c.firebasestorage.app",
            messagingSenderId: "625498466879",
            appId: "1:625498466879:web:af13aeeac06d532de9e68a",
            measurementId: "G-DDVF4NPEXV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- State Variables ---
        let currentUser = null;
        let isSignUpMode = false;
        let unsubscribeNotes = null;
        let allNotes = [];
        let currentEditingNoteId = null; // null means new note, but we generate one when attachments are added
        let currentAttachments = [];

        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const editorScreen = document.getElementById('editor-screen');
        
        // Auth Elements
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const authError = document.getElementById('auth-error');
        
        // App Elements
        const userEmailDisplay = document.getElementById('user-email-display');
        const signoutBtn = document.getElementById('signout-btn');
        const notesGrid = document.getElementById('notes-grid');
        const emptyState = document.getElementById('empty-state');
        const loadingIndicator = document.getElementById('loading-indicator');
        const addNoteFab = document.getElementById('add-note-fab');
        
        // Dialog Elements
        const confirmDialog = document.getElementById('confirm-dialog');
        const confirmDialogCard = document.getElementById('confirm-dialog-card');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');

        // Editor Elements
        const backBtn = document.getElementById('back-btn');
        const editorTitleInput = document.getElementById('editor-title');
        const editorContentInput = document.getElementById('editor-content');
        const editorSaveBtn = document.getElementById('editor-save-btn');
        const editorDeleteBtn = document.getElementById('editor-delete-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const attachmentInput = document.getElementById('attachment-input');
        const attachmentsContainer = document.getElementById('attachments-container');
        const attachmentsList = document.getElementById('attachments-list');

        // Snackbar Elements
        const snackbar = document.getElementById('snackbar');
        const snackbarText = document.getElementById('snackbar-text');
        const snackbarIcon = document.getElementById('snackbar-icon');

        // --- UI Utilities ---
        function showSnackbar(message, isSpinner = false) {
            snackbarText.textContent = message;
            if (isSpinner) {
                snackbarIcon.textContent = 'progress_activity';
                snackbarIcon.classList.add('animate-spin');
                snackbarIcon.classList.remove('hidden');
            } else {
                snackbarIcon.classList.add('hidden');
                snackbarIcon.classList.remove('animate-spin');
            }
            
            snackbar.classList.add('show');
            
            if (!isSpinner) {
                setTimeout(() => {
                    snackbar.classList.remove('show');
                }, 3000);
            }
        }

        function hideSnackbar() {
            snackbar.classList.remove('show');
        }

        function escapeHtml(unsafe) {
            return (unsafe || '').replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatBytes(bytes, decimals = 1) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        // Custom Confirm Dialog wrapper
        function showConfirm(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmDialog.classList.remove('hidden');
            // trigger reflow
            void confirmDialog.offsetWidth;
            confirmDialog.classList.remove('opacity-0');
            confirmDialogCard.classList.remove('scale-95');

            const handleCancel = () => {
                closeConfirm();
            };
            
            const handleConfirm = () => {
                closeConfirm();
                onConfirm();
            };

            // Remove old listeners and add new ones
            confirmCancelBtn.onclick = handleCancel;
            confirmActionBtn.onclick = handleConfirm;
        }

        function closeConfirm() {
            confirmDialog.classList.add('opacity-0');
            confirmDialogCard.classList.add('scale-95');
            setTimeout(() => {
                confirmDialog.classList.add('hidden');
            }, 200);
        }

        // --- Routing Logic ---
        function handleRouting() {
            if (!currentUser) {
                appScreen.classList.add('hidden');
                editorScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                return;
            }

            const hash = window.location.hash;
            authScreen.classList.add('hidden');

            if (hash.startsWith('#note/')) {
                const noteId = hash.replace('#note/', '');
                openEditor(noteId);
            } else {
                editorScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                currentEditingNoteId = null;
                currentAttachments = [];
            }
        }

        window.addEventListener('hashchange', handleRouting);

        // --- Authentication Flow ---
        toggleAuthModeBtn.addEventListener('click', () => {
            isSignUpMode = !isSignUpMode;
            authTitle.textContent = isSignUpMode ? 'Create Account' : 'Welcome Back';
            authSubmitBtn.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            toggleAuthModeBtn.textContent = isSignUpMode ? 'Sign in instead' : 'Create an account instead';
            authError.classList.add('hidden');
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            authError.classList.add('hidden');
            authSubmitBtn.disabled = true;
            authSubmitBtn.style.opacity = '0.7';

            try {
                if (isSignUpMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                authError.textContent = getFriendlyErrorMessage(error.code);
                authError.classList.remove('hidden');
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.style.opacity = '1';
            }
        });

        googleSigninBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                showSnackbar("Google sign-in failed.");
                console.error(error);
            }
        });

        signoutBtn.addEventListener('click', () => {
            signOut(auth);
            window.location.hash = ''; 
        });

        function getFriendlyErrorMessage(code) {
            switch (code) {
                case 'auth/user-not-found': return 'No account found.';
                case 'auth/wrong-password': return 'Incorrect password.';
                case 'auth/email-already-in-use': return 'Email already registered.';
                case 'auth/weak-password': return 'Password should be at least 6 characters.';
                case 'auth/invalid-credential': return 'Invalid email or password.';
                default: return 'An error occurred. Please try again.';
            }
        }

        // --- Auth State Listener ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                userEmailDisplay.textContent = user.email || 'Google User';
                startNotesListener();
                handleRouting(); 
            } else {
                if (unsubscribeNotes) {
                    unsubscribeNotes();
                    unsubscribeNotes = null;
                }
                notesGrid.innerHTML = '';
                handleRouting();
            }
        });

        // --- Firestore Operations (Home Screen) ---
        function startNotesListener() {
            if (!currentUser) return;
            loadingIndicator.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const notesRef = collection(db, 'users', currentUser.uid, 'notes');
            
            unsubscribeNotes = onSnapshot(notesRef, (snapshot) => {
                allNotes = [];
                snapshot.forEach(doc => {
                    allNotes.push({ id: doc.id, ...doc.data() });
                });

                allNotes.sort((a, b) => {
                    const timeA = a.updatedAt ? a.updatedAt.toMillis() : (a.createdAt ? a.createdAt.toMillis() : 0);
                    const timeB = b.updatedAt ? b.updatedAt.toMillis() : (b.createdAt ? b.createdAt.toMillis() : 0);
                    return timeB - timeA;
                });

                if (!window.location.hash.startsWith('#note/')) {
                    renderNotes(allNotes);
                }
                
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error listening to notes:", error);
                showSnackbar("Error loading notes.");
                loadingIndicator.classList.add('hidden');
            });
        }

        function renderNotes(notes) {
            notesGrid.innerHTML = '';
            if (notes.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            notes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card p-4 h-56 group relative cursor-pointer';
                
                const title = note.title || 'Untitled Note';
                const content = note.content || '';
                const date = note.updatedAt ? new Date(note.updatedAt.toMillis()).toLocaleDateString() : 'Draft';
                const hasAttachments = note.attachments && note.attachments.length > 0;

                card.innerHTML = `
                    <div class="flex-grow overflow-hidden relative">
                        <h3 class="text-lg font-medium text-[#1f1f1f] mb-2 truncate google-sans pr-6">${escapeHtml(title)}</h3>
                        ${hasAttachments ? `<span class="absolute top-0 right-0 material-symbols-outlined text-[#747775] text-[20px]" title="${note.attachments.length} attachment(s)">attach_file</span>` : ''}
                        <p class="text-[#444746] text-sm whitespace-pre-wrap line-clamp-5">${escapeHtml(content)}</p>
                    </div>
                    <div class="mt-4 pt-3 border-t border-[#e0e2e0] flex items-center justify-between text-xs text-[#747775]">
                        <span>${date}</span>
                        <button class="delete-btn w-8 h-8 rounded-full hover:bg-[#ffdad6] hover:text-[#ba1a1a] flex items-center justify-center transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100" title="Delete Note" data-id="${note.id}">
                            <span class="material-symbols-outlined text-[18px] pointer-events-none">delete</span>
                        </button>
                    </div>
                `;

                card.addEventListener('click', (e) => {
                    if(!e.target.classList.contains('delete-btn')) {
                        window.location.hash = `#note/${note.id}`;
                    }
                });

                const deleteBtn = card.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirm("Delete Note", "Are you sure you want to delete this note? This will also delete any attached files.", async () => {
                        await deleteNote(note.id, note.attachments);
                    });
                });

                notesGrid.appendChild(card);
            });
        }

        // --- Editor Actions ---
        addNoteFab.addEventListener('click', () => {
            window.location.hash = '#note/new';
        });

        backBtn.addEventListener('click', () => {
            window.location.hash = '#home'; 
        });

        async function openEditor(noteId) {
            appScreen.classList.add('hidden');
            editorScreen.classList.remove('hidden');
            
            if (noteId === 'new') {
                currentEditingNoteId = null;
                editorTitleInput.value = '';
                editorContentInput.value = '';
                currentAttachments = [];
                renderAttachments();
                editorDeleteBtn.classList.add('hidden');
                editorTitleInput.focus();
            } else {
                currentEditingNoteId = noteId;
                editorDeleteBtn.classList.remove('hidden');
                
                const existingNote = allNotes.find(n => n.id === noteId);
                
                if (existingNote) {
                    populateEditor(existingNote);
                } else {
                    // Fetch if not in memory (direct link)
                    editorTitleInput.value = 'Loading...';
                    editorContentInput.value = 'Loading...';
                    try {
                        const docRef = doc(db, 'users', currentUser.uid, 'notes', noteId);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            populateEditor({id: docSnap.id, ...docSnap.data()});
                        } else {
                            showSnackbar("Note not found");
                            window.location.hash = '#home';
                        }
                    } catch (error) {
                        console.error("Error fetching note:", error);
                        showSnackbar("Error loading note");
                        window.location.hash = '#home';
                    }
                }
            }
        }

        function populateEditor(noteData) {
            editorTitleInput.value = noteData.title || '';
            editorContentInput.value = noteData.content || '';
            currentAttachments = noteData.attachments || [];
            renderAttachments();
        }

        // --- Saving Notes ---
        editorSaveBtn.addEventListener('click', async () => {
            await performSave(true);
        });

        async function performSave(manualTrigger = false) {
            const title = editorTitleInput.value.trim();
            const content = editorContentInput.value.trim();

            if (!title && !content && currentAttachments.length === 0) {
                if(manualTrigger) window.location.hash = '#home';
                return;
            }

            if (!currentUser) return;
            
            if (manualTrigger) {
                editorSaveBtn.disabled = true;
                editorSaveBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">progress_activity</span><span class="hidden sm:inline">Saving</span>';
            }

            try {
                let noteRef;
                if (!currentEditingNoteId) {
                    // Create new reference
                    noteRef = doc(collection(db, 'users', currentUser.uid, 'notes'));
                    currentEditingNoteId = noteRef.id;
                    // Update URL gracefully so refresh doesn't bring us to empty "new"
                    window.history.replaceState(null, '', `#note/${currentEditingNoteId}`);
                    editorDeleteBtn.classList.remove('hidden');
                } else {
                    noteRef = doc(db, 'users', currentUser.uid, 'notes', currentEditingNoteId);
                }

                const noteData = {
                    title,
                    content,
                    attachments: currentAttachments,
                    updatedAt: serverTimestamp()
                };

                // setDoc with merge: true creates doc if it doesn't exist, updates if it does
                await setDoc(noteRef, noteData, { merge: true });

                // Set createdAt only if it's new (checking if we manually triggered it for the first time might be tricky, but merging handles it well)
                
                if (manualTrigger) {
                    showSnackbar("Note saved");
                    window.location.hash = '#home'; // Return home after explicit save
                }
            } catch (error) {
                console.error("Error saving note:", error);
                if(manualTrigger) showSnackbar("Error saving note");
            } finally {
                if (manualTrigger) {
                    editorSaveBtn.disabled = false;
                    editorSaveBtn.innerHTML = '<span class="material-symbols-outlined text-[18px]">save</span><span class="hidden sm:inline">Save</span>';
                }
            }
        }

        // --- Attachment Handling ---
        attachFileBtn.addEventListener('click', () => {
            attachmentInput.click();
        });

        attachmentInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                await uploadAttachments(files);
                attachmentInput.value = ''; // Reset input
            }
        });

        async function uploadAttachments(files) {
            if (!currentUser) return;
            
            // If note doesn't exist yet, we must create a draft in Firestore first
            // to get an ID for the Storage path.
            if (!currentEditingNoteId) {
                await performSave(false); // background save
            }

            showSnackbar(`Uploading ${files.length} file(s)...`, true);

            for (const file of files) {
                // Prevent filename collisions by prefixing timestamp
                const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const filePath = `users/${currentUser.uid}/notes/${currentEditingNoteId}/${Date.now()}_${safeName}`;
                const storageRef = ref(storage, filePath);

                try {
                    const snapshot = await uploadBytesResumable(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    
                    currentAttachments.push({
                        name: file.name,
                        url: downloadURL,
                        path: filePath,
                        type: file.type,
                        size: file.size
                    });
                    renderAttachments();
                } catch (error) {
                    console.error("File upload error:", error);
                    showSnackbar(`Failed to upload ${file.name}`);
                }
            }

            hideSnackbar();
            // Automatically save note to store attachment metadata
            await performSave(false);
        }

        function renderAttachments() {
            if (currentAttachments.length === 0) {
                attachmentsContainer.classList.add('hidden');
                attachmentsList.innerHTML = '';
                return;
            }

            attachmentsContainer.classList.remove('hidden');
            attachmentsList.innerHTML = '';

            currentAttachments.forEach((att, index) => {
                const isImage = att.type?.startsWith('image/');
                const iconName = isImage ? 'image' : 'description';

                const chip = document.createElement('div');
                chip.className = 'm3-chip';
                chip.innerHTML = `
                    <span class="material-symbols-outlined text-[16px] text-[#0b57d0]">${iconName}</span>
                    <a href="${att.url}" target="_blank" rel="noopener noreferrer" class="chip-text hover:underline text-[#0b57d0]" title="${escapeHtml(att.name)} (${formatBytes(att.size)})">
                        ${escapeHtml(att.name)}
                    </a>
                    <button class="remove-att-btn w-5 h-5 rounded-full flex items-center justify-center hover:bg-[#e1e2e8] text-[#444746] ml-1 transition-colors" data-index="${index}" title="Remove file">
                        <span class="material-symbols-outlined text-[14px] pointer-events-none">close</span>
                    </button>
                `;
                attachmentsList.appendChild(chip);
            });

            // Bind remove events
            document.querySelectorAll('.remove-att-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const idx = e.target.getAttribute('data-index');
                    removeAttachment(idx);
                });
            });
        }

        async function removeAttachment(index) {
            const att = currentAttachments[index];
            if (!att) return;

            showConfirm("Remove Attachment", `Remove "${att.name}" from this note?`, async () => {
                try {
                    // Delete from storage
                    const storageRef = ref(storage, att.path);
                    await deleteObject(storageRef);
                } catch (error) {
                    console.warn("Could not delete from storage, might be already gone:", error);
                }

                // Remove from local array & re-render
                currentAttachments.splice(index, 1);
                renderAttachments();
                
                // Save note to update Firestore array
                await performSave(false);
            });
        }

        // --- Deletion Flow ---
        editorDeleteBtn.addEventListener('click', () => {
            if (!currentEditingNoteId) return;
            showConfirm("Delete Note", "Are you sure you want to delete this note? This will also delete any attached files.", async () => {
                await deleteNote(currentEditingNoteId, currentAttachments);
                window.location.hash = '#home';
            });
        });

        async function deleteNote(noteId, attachmentsArray) {
            if (!currentUser) return;
            try {
                // 1. Delete all attachments in storage first
                if (attachmentsArray && attachmentsArray.length > 0) {
                    for (const att of attachmentsArray) {
                        try {
                            const storageRef = ref(storage, att.path);
                            await deleteObject(storageRef);
                        } catch (e) {
                            console.warn(`Failed to delete storage object ${att.path}`, e);
                        }
                    }
                }

                // 2. Delete Firestore Document
                await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', noteId));
                showSnackbar("Note deleted");
            } catch (error) {
                console.error("Error deleting note:", error);
                showSnackbar("Failed to delete note");
            }
        }
    </script>
</body>
</html>


